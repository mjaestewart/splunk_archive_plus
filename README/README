## README

#########################
Dev'd by: Mark Stewart
Organization: Splunk
#########################



This app provides a method of transferring frozen originating archive buckets from an indexer's coldToFrozenDir to an Azure Blob Storage presented to a proxy server. 

This app run with the following components:

inputs.conf = scripted input executes script on intervals AND monitors the scripting outputs
indexes.conf = sets the indexes for event ingestion from the scripting output
spl_frozen_archive.sh = 
            - copies the originating (db_) and (rb_) buckets from local frozen repositories to Azure blob via MinIo, NAS vi cp, SAN via cp, or AWS via cli command.
            - MD5 sums are set on ALL frozen buckets/journal.gz files for integritey checks
            - MD5 sums are used to validate successful copy of archived data from source to destination
						- Removes ALL originating local frozen buckets on all search peers (db_ AND rb_) upon a successful copy
						- Deduplicates the replicated archive buckets (rb_) and keeps ALL originating (db_) buckets to save on storage footprint
            - Logs all events for copies, MD5 sums, and deduplicated replicated bucket removals
            - indexes logs in Splunk to index = archive_copy, index = archive_remove


##################
## Prereq's
##################

- Set the coldToFrozenDir on the indexes to be rolled to frozen in indexes.conf
- Set the path to:
		coldToFrozenDir = $SPLUNK_DB/INDEX_NAME/frozen
- Ensure the script has the proper permissions to copy and delete buckets on the search peers (indexers)
- Typically, the Azure Blob Storage is mounted or presented to a proxy server.
- Ensure the account running the frozen script has permissions on the proxy server 
  to read and write. 


##################
## Here is the logic in the Azure copy function:
##################

- The  script is designed to copy originating db_ Splunk Archive buckets to an Azure Blob Storage
  from the indexes coldToFrozenDir path
- To prevent duplicated rb_ replicated archive buckets from copying to the Azure
  Blob Storage only the db_ originating buckets are copied.
- After the successful copy of the originating archive files a conditional check will ensure the 
  copy was successful then delete the originating db_ bucket from the frozen directory.
- If the copy fails then no buckets will be deleted. 
- All activity gets logged to /opt/splunk/var/log/splunk/frozen_copy.log

##################
## Here is the logic in the Replicated Archive Buckets function:
##################

- The script recursively finds all replicated archive files in the coldToFrozenDir path
  that are replicated copies (rb_)
- A conditional check validates the successful existence of rb_ replicated archive buckets
- if rb_ jurnal.gz exist then remove the replicated archive buckets
- All activity gets logged to /opt/splunk/var/log/splunk/rb_archive_rm.log

##########################
## spl_frozen_archive.sh
##########################

- ** Be sure to set the FROZEN_DB_NAME global variable in the script
- ** If "frozen" is not the path in the coldToFrozenDir path then set
     the correct value on the global variable

     ** coldToFrozenDir = $SPLUNK_DB/_internal/frozen
     - In the above reference the global variable would be set to:
              - FROZEN_DB_NAME='frozen' 

##################
## inputs.conf
##################

- The scripted inputs executes the script to enforce the time based interval of excution on the spl_frozen_archive.sh script.
- Change the inputs values as necessary.
- All script logging is output and monitored in /opt/splunk/var/log/splunk/
- Logic in the script only keeps a total of 5 log files. 
- Every execution run of the script a log rotates and prunes the oldest. 

##################
##################

## Scripted Input for Azure Frozen Copy Job

[script://./bin/spl_frozen_archive.sh]
disabled = 0
sourcetype = azure_copy
# for testing: every 2 mins
interval = 120
# execute every 24 hours
#interval = 86400

[monitor:///opt/splunk/var/log/splunk/ARCHIVE_copy.log*]
disabled = 0
sourcetype = archive_copy
index = archive_copy

[monitor:///opt/splunk/var/log/splunk/ARCHIVE_rb_remove.log*]
disabled = 0
sourcetype = archive_remove
index = archive_remove

##################
##################


##################
## indexes.conf
##################

- If there is an indexes all app then paste these stanzas into that app's indexes.conf
- Tthen remove this indexes.conf from the app

##################
##################

[azure_frozen]
homePath = volume:primary/azure_frozen/db
coldPath = volume:primary/azure_frozen/colddb
thawedPath = $SPLUNK_DB/azure_frozen/thaweddb
coldToFrozenDir = $SPLUNK_DB/azure_frozen/frozen
frozenTimePeriodInSecs = 220752000

[archive_rm]
homePath = volume:primary/archive_rm/db
coldPath = volume:primary/archive_rm/colddb
thawedPath = $SPLUNK_DB/archive_rm/thaweddb
coldToFrozenDir = $SPLUNK_DB/archive_rm/frozen
frozenTimePeriodInSecs = 220752000

##################
##################
